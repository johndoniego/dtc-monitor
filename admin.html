<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DTC Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; }
    * { font-family: 'Plus Jakarta Sans', sans-serif; }
    .form-section {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #0ea5e9;
    }
    .section-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    .input-group { margin-bottom: 16px; }
    .input-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      font-weight: 600;
      color: #334155;
      margin-bottom: 6px;
    }
    .input-label .required { color: #ef4444; }
    .input-field {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.2s ease;
      background: white;
    }
    .input-field:focus {
      outline: none;
      border-color: #0ea5e9;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }
    .submit-btn {
      width: 100%;
      padding: 16px 32px;
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      color: white;
      font-size: 16px;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(14, 165, 233, 0.3);
    }
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      left: 24px;
      max-width: 400px;
      margin-left: auto;
      padding: 16px 24px;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }
    .toast.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .toast.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .header-banner {
      background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
      color: white;
      padding: 32px;
      border-radius: 20px;
      margin-bottom: 24px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .header-banner::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 60%);
      animation: shimmer 3s infinite;
    }
    @keyframes shimmer {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .logo-container {
      width: 80px;
      height: 80px;
      background: white;
      border-radius: 50%;
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .confirm-no {
      background: white;
      color: #64748b;
      padding: 12px 24px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .confirm-no:hover {
      border-color: #ef4444;
      color: #ef4444;
    }
    .pagination-btn {
      padding: 8px 12px;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .pagination-btn:hover:not(:disabled) {
      border-color: #0ea5e9;
      background: #f0f9ff;
      color: #0ea5e9;
    }
    .pagination-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .pagination-btn.active {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      border-color: #0ea5e9;
      color: white;
    }
    .stat-card {
      text-align: center;
      padding: 20px;
    }
    .stat-card .icon {
      margin-bottom: 8px;
    }
    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
    }
    .stat-card .label {
      font-size: 14px;
      color: #64748b;
      font-weight: 600;
    }
    .export-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }
    .export-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
    }
    .login-container {
      max-width: 400px;
      margin: 100px auto;
    }
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    .stats-tab {
      padding: 10px 20px;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .stats-tab:hover {
      border-color: #0ea5e9;
      color: #0ea5e9;
    }
    .stats-tab.active {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      border-color: #0ea5e9;
      color: white;
    }
    .chart-type-btn {
      padding: 8px 16px;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .chart-type-btn:hover {
      border-color: #0ea5e9;
      color: #0ea5e9;
    }
    .chart-type-btn.active {
      background: #0ea5e9;
      border-color: #0ea5e9;
      color: white;
    }
    /* Collapsible Sections */
    .section-header {
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    .section-header .collapse-icon {
      margin-left: auto;
      transition: transform 0.3s ease;
    }
    .section-header.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }
    .section-content {
      transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
      overflow: hidden;
    }
    .section-content.collapsed {
      max-height: 0 !important;
      opacity: 0;
      padding-top: 0;
      padding-bottom: 0;
    }
    /* Filter styles */
    .filter-btn {
      padding: 6px 14px;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    .filter-btn:hover {
      border-color: #0ea5e9;
      color: #0ea5e9;
      background: #f0f9ff;
    }
    .filter-btn.active {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      border-color: #0ea5e9;
      color: white;
    }
    /* Responsive Styles */
    @media (max-width: 992px) {
      .stats-grid { grid-template-columns: repeat(3, 1fr) !important; }
      .filter-grid { grid-template-columns: repeat(2, 1fr) !important; }
      .charts-grid { grid-template-columns: 1fr !important; }
    }
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr) !important; }
      .filter-grid { grid-template-columns: 1fr !important; }
      .form-section { padding: 16px; margin-bottom: 16px; }
      .section-header { flex-direction: row; gap: 8px; }
      .section-header .collapse-icon { margin-left: auto; }
      .header-banner { padding: 20px 16px; }
      .header-banner h1 { font-size: 1.5rem; }
      .header-banner p { font-size: 0.9rem; }
      .logo-container { width: 60px; height: 60px; }
      .logo-container img { width: 50px; height: 50px; }
      .stat-card { padding: 16px; }
      .stat-card .value { font-size: 24px; }
      .stat-card .label { font-size: 12px; }
      .stat-card .icon svg { width: 32px; height: 32px; }
      .top-bar { flex-direction: column; align-items: stretch !important; }
      .export-buttons { width: 100%; justify-content: center; }
      .export-btn { flex: 1; justify-content: center; padding: 12px 16px; font-size: 13px; }
      #logoutBtn { width: 100%; justify-content: center; }
      .pagination-btn { padding: 6px 10px; font-size: 12px; }
      table { font-size: 12px; }
      table th, table td { padding: 8px 6px; }
      .input-field { padding: 10px 12px; font-size: 16px; }
      .filter-btn { padding: 5px 10px; font-size: 11px; }
      #dateRangeContainer { width: 100%; margin-left: 0 !important; margin-top: 12px; justify-content: center; }
      #dateRangeContainer input[type="date"] { width: 120px !important; }
      #dateRangeContainer input[type="time"] { width: 90px !important; }
    }
    @media (max-width: 600px) {
      .stats-grid { grid-template-columns: 1fr 1fr !important; }
      .login-container { margin: 40px auto; padding: 12px; }
      .max-w-6xl { padding: 12px; }
      .header-banner { padding: 16px 12px; border-radius: 14px; }
      .header-banner h1 { font-size: 1.25rem; }
      .export-btn span { display: none; }
      .export-btn svg { margin: 0; }
      .chart-type-btn span { display: none; }
      .chart-type-btn { padding: 10px 12px; }
      .stats-tab { padding: 8px 14px; font-size: 13px; }
      #dateRangeContainer input[type="time"] { display: none; }
    }
    @media (max-width: 480px) {
      .stats-grid { grid-template-columns: 1fr !important; }
      table { font-size: 11px; }
      table th, table td { padding: 6px 4px; }
      .pagination-container { flex-direction: column; gap: 12px; align-items: center !important; }
      .filter-btn { padding: 4px 8px; font-size: 10px; }
      .stats-tab { padding: 6px 10px; font-size: 11px; }
    }
  </style>
 </head>
 <body class="h-full bg-gradient-to-br from-slate-100 to-slate-200">
  <div id="app" class="h-full overflow-auto">
   <!-- Login Form (shown by default) -->
   <div id="loginSection" class="login-container p-6">
    <div class="form-section">
     <div style="text-align: center; margin-bottom: 24px;">
      <div style="width: 100px; height: 100px; background: white; border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
       <img src="dict-logo.png" alt="DICT Logo" style="width: 80px; height: 80px; object-fit: contain;">
      </div>
      <h1 class="text-2xl font-bold text-slate-800">Admin Login</h1>
      <p class="text-slate-500 mt-2">DTC Tuguegarao Dashboard</p>
     </div>
     <form id="adminForm">
      <div class="input-group">
       <label for="adminUsername" class="input-label">Username <span class="required">*</span></label>
       <input type="text" id="adminUsername" class="input-field" placeholder="Enter username" required>
      </div>
      <div class="input-group">
       <label for="adminPassword" class="input-label">Password <span class="required">*</span></label>
       <input type="password" id="adminPassword" class="input-field" placeholder="Enter password" required>
      </div>
      <button type="submit" id="adminLoginBtn" class="submit-btn">
       <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>
       Login
      </button>
     </form>
    </div>
   </div>

   <!-- Admin Dashboard (hidden until login) -->
   <div id="adminDashboard" class="max-w-6xl mx-auto p-6" style="display: none;">
    <!-- Header -->
    <div class="header-banner">
     <div class="logo-container">
      <img src="dict-logo.png" alt="DICT Logo" style="width: 70px; height: 70px; object-fit: contain;">
     </div>
     <h1 class="text-2xl md:text-3xl font-bold mb-2">Admin Dashboard</h1>
     <p class="text-lg opacity-90">DTC Tuguegarao Attendance System</p>
    </div>

    <!-- Top Bar -->
    <div class="top-bar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
     <div class="export-buttons" style="display: flex; gap: 12px; flex-wrap: wrap;">
      <button id="exportRegBtn" class="export-btn">
       <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
       <span>Export Registrations</span>
      </button>
      <button id="exportCheckinBtn" class="export-btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
       <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
       <span>Export Check-ins</span>
      </button>
     </div>
     <button id="logoutBtn" class="confirm-no" style="padding: 10px 20px; display: flex; align-items: center; gap: 8px;">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
      <span>Logout</span>
     </button>
    </div>

    <!-- Statistics Section -->
    <div class="form-section" style="margin-bottom: 24px;" id="statsSection">
     <div class="section-header" onclick="toggleSection('stats')">
      <div class="section-icon">
       <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
      </div>
      <h2 class="text-xl font-bold text-slate-800">Statistics Overview</h2>
      <svg class="collapse-icon" width="24" height="24" fill="#64748b" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
     </div>
     
     <div class="section-content" id="statsContent">
      <!-- Stats Period Tabs -->
      <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
       <button class="stats-tab active" onclick="switchStatsPeriod('today')" id="tabToday">ðŸ“… Today</button>
       <button class="stats-tab" onclick="switchStatsPeriod('all')" id="tabAll">ðŸ“Š All Time</button>
       <div style="margin-left: auto; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;" id="dateRangeContainer">
        <div style="display: flex; gap: 4px; align-items: center;">
         <input type="date" id="statsDateFrom" class="input-field" style="padding: 8px 10px; width: 130px;">
         <input type="time" id="statsTimeFrom" class="input-field" style="padding: 8px 10px; width: 100px;">
        </div>
        <span style="color: #94a3b8; font-size: 13px;">to</span>
        <div style="display: flex; gap: 4px; align-items: center;">
         <input type="date" id="statsDateTo" class="input-field" style="padding: 8px 10px; width: 130px;">
         <input type="time" id="statsTimeTo" class="input-field" style="padding: 8px 10px; width: 100px;">
        </div>
       </div>
      </div>
      
      <!-- Filter & Sort Row -->
      <div style="display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
       <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
        <span style="font-size: 13px; font-weight: 600; color: #64748b;">Show:</span>
        <button class="filter-btn active" onclick="setStatsFilter('all')" id="filterAll">All</button>
        <button class="filter-btn" onclick="setStatsFilter('registrations')" id="filterRegistrations">Registrations</button>
        <button class="filter-btn" onclick="setStatsFilter('checkins')" id="filterCheckins">Check-ins</button>
        <button class="filter-btn" onclick="setStatsFilter('printing')" id="filterPrinting">Printing</button>
        <button class="filter-btn" onclick="setStatsFilter('pcuse')" id="filterPcuse">PC Use</button>
        <button class="filter-btn" onclick="setStatsFilter('training')" id="filterTraining">Training</button>
       </div>
       <div style="margin-left: auto; display: flex; gap: 8px; align-items: center;">
        <span style="font-size: 13px; font-weight: 600; color: #64748b;">Sort:</span>
        <select id="statsSortSelect" class="input-field" style="padding: 8px 12px; min-width: 140px;" onchange="setStatsSortFromSelect(this.value)">
         <option value="newest">Newest First</option>
         <option value="oldest">Oldest First</option>
         <option value="highest">Highest Count</option>
         <option value="lowest">Lowest Count</option>
        </select>
        <button onclick="resetStatsFilters()" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap;">Reset</button>
       </div>
      </div>
      
      <!-- Filtered Stats Display -->
      <div id="filteredStatsDisplay">
       <div class="stats-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 20px;" id="statsCardsGrid">
        <div class="form-section stat-card" style="margin-bottom: 0;" id="cardRegistrations">
         <div class="icon"><svg width="40" height="40" fill="#10b981" viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.89 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg></div>
         <div id="filteredRegistrations" class="value" style="color: #10b981;">0</div>
         <div class="label">Registrations</div>
        </div>
        <div class="form-section stat-card" style="margin-bottom: 0;" id="cardCheckins">
         <div class="icon"><svg width="40" height="40" fill="#06b6d4" viewBox="0 0 24 24"><path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/></svg></div>
         <div id="filteredCheckins" class="value" style="color: #06b6d4;">0</div>
         <div class="label">Check-ins</div>
        </div>
        <div class="form-section stat-card" style="margin-bottom: 0;" id="cardPrinting">
         <div class="icon"><svg width="40" height="40" fill="#f59e0b" viewBox="0 0 24 24"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg></div>
         <div id="filteredPrinting" class="value" style="color: #f59e0b;">0</div>
         <div class="label">Printing</div>
        </div>
        <div class="form-section stat-card" style="margin-bottom: 0;" id="cardPcuse">
         <div class="icon"><svg width="40" height="40" fill="#8b5cf6" viewBox="0 0 24 24"><path d="M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"/></svg></div>
         <div id="filteredPcUse" class="value" style="color: #8b5cf6;">0</div>
         <div class="label">PC Use</div>
        </div>
        <div class="form-section stat-card" style="margin-bottom: 0;" id="cardTraining">
         <div class="icon"><svg width="40" height="40" fill="#ec4899" viewBox="0 0 24 24"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg></div>
         <div id="filteredTraining" class="value" style="color: #ec4899;">0</div>
         <div class="label">Training</div>
        </div>
       </div>
      </div>
      
      <!-- Date Range Display -->
      <div id="statsDateRangeInfo" style="text-align: center; padding: 10px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 8px; font-size: 13px; color: #0369a1; font-weight: 600;">
       Showing statistics for: <span id="statsDateRangeText">Today</span>
      </div>
     </div>
    </div>

    <!-- Registration Logbook -->
    <div class="form-section" id="regSection">
     <div class="section-header" onclick="toggleSection('reg')">
      <div class="section-icon">
       <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z"/></svg>
      </div>
      <h2 class="text-xl font-bold text-slate-800">Registration Logbook</h2>
      <svg class="collapse-icon" width="24" height="24" fill="#64748b" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
     </div>
     <div class="section-content" id="regContent">
     <!-- Filters -->
     <div class="filter-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; margin-bottom: 16px;">
      <div>
       <label style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 4px;">Search</label>
       <input type="text" id="regSearchInput" placeholder="Search name, email, ID..." class="input-field" style="padding: 10px;">
      </div>
      <div>
       <label style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 4px;">Filter by Agency</label>
       <select id="regAgencyFilter" class="input-field" style="padding: 10px;"><option value="">All Agencies</option></select>
      </div>
      <div>
       <label style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 4px;">Sort by</label>
       <select id="regSortSelect" class="input-field" style="padding: 10px;">
        <option value="date_desc">Date (Newest First)</option>
        <option value="date_asc">Date (Oldest First)</option>
        <option value="name_asc">Name (A-Z)</option>
        <option value="name_desc">Name (Z-A)</option>
       </select>
      </div>
      <div>
       <label style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 4px;">Per Page</label>
       <select id="regPerPageSelect" class="input-field" style="padding: 10px;">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="50">50</option>
       </select>
      </div>
     </div>
     <div style="overflow-x: auto;">
      <table id="registrationTable" style="width: 100%; border-collapse: collapse; font-size: 13px;">
       <thead>
        <tr style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white;">
         <th style="padding: 12px; text-align: left; border: 1px solid #0284c7;">Reg #</th>
         <th style="padding: 12px; text-align: left; border: 1px solid #0284c7;">User ID</th>
         <th style="padding: 12px; text-align: left; border: 1px solid #0284c7;">Name</th>
         <th style="padding: 12px; text-align: left; border: 1px solid #0284c7;">Email</th>
         <th style="padding: 12px; text-align: left; border: 1px solid #0284c7;">Agency</th>
         <th style="padding: 12px; text-align: left; border: 1px solid #0284c7;">Region</th>
         <th style="padding: 12px; text-align: left; border: 1px solid #0284c7;">Date</th>
        </tr>
       </thead>
       <tbody id="registrationTableBody">
        <tr><td colspan="7" style="padding: 40px; text-align: center; color: #94a3b8;">No registrations yet</td></tr>
       </tbody>
      </table>
     </div>
     <div id="regPagination" class="pagination-container" style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 2px solid #e2e8f0; flex-wrap: wrap; gap: 12px;">
      <div style="font-size: 14px; color: #64748b;">Showing <span id="regShowingStart">0</span>-<span id="regShowingEnd">0</span> of <span id="regShowingTotal">0</span></div>
      <div id="regPaginationButtons" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
     </div>
     </div>
    </div>

    <!-- Check-in Logbook -->
    <div class="form-section" id="checkinSection">
     <div class="section-header" style="border-color: #10b981;" onclick="toggleSection('checkin')">
      <div class="section-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
       <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/></svg>
      </div>
      <h2 class="text-xl font-bold text-slate-800">Check-In Logbook</h2>
      <svg class="collapse-icon" width="24" height="24" fill="#64748b" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
     </div>
     <div class="section-content" id="checkinContent">
     <!-- Filters -->
     <div class="filter-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; margin-bottom: 16px;">
      <div>
       <label style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 4px;">Search</label>
       <input type="text" id="checkinSearchInput" placeholder="Search user ID, services..." class="input-field" style="padding: 10px;">
      </div>
      <div>
       <label style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 4px;">Filter by Service</label>
       <select id="checkinServiceFilter" class="input-field" style="padding: 10px;">
        <option value="">All Services</option>
        <option value="Printing">Printing</option>
        <option value="PC Use">PC Use</option>
        <option value="Training">Training</option>
       </select>
      </div>
      <div>
       <label style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 4px;">Sort by</label>
       <select id="checkinSortSelect" class="input-field" style="padding: 10px;">
        <option value="date_desc">Date (Newest First)</option>
        <option value="date_asc">Date (Oldest First)</option>
        <option value="id_asc">User ID (A-Z)</option>
        <option value="id_desc">User ID (Z-A)</option>
       </select>
      </div>
      <div>
       <label style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 4px;">Per Page</label>
       <select id="checkinPerPageSelect" class="input-field" style="padding: 10px;">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="50">50</option>
       </select>
      </div>
     </div>
     <div style="overflow-x: auto;">
      <table id="checkinTable" style="width: 100%; border-collapse: collapse; font-size: 13px;">
       <thead>
        <tr style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
         <th style="padding: 12px; text-align: left; border: 1px solid #059669;">User ID</th>
         <th style="padding: 12px; text-align: left; border: 1px solid #059669;">Name</th>
         <th style="padding: 12px; text-align: left; border: 1px solid #059669;">Services</th>
         <th style="padding: 12px; text-align: left; border: 1px solid #059669;">Check-In Time</th>
        </tr>
       </thead>
       <tbody id="checkinTableBody">
        <tr><td colspan="4" style="padding: 40px; text-align: center; color: #94a3b8;">No check-ins yet</td></tr>
       </tbody>
      </table>
     </div>
     <div id="checkinPagination" class="pagination-container" style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 2px solid #e2e8f0; flex-wrap: wrap; gap: 12px;">
      <div style="font-size: 14px; color: #64748b;">Showing <span id="checkinShowingStart">0</span>-<span id="checkinShowingEnd">0</span> of <span id="checkinShowingTotal">0</span></div>
      <div id="checkinPaginationButtons" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
     </div>
     </div>
    </div>

    <!-- Charts Section -->
    <div class="form-section" style="margin-bottom: 24px;" id="chartsSection">
     <div class="section-header" style="border-color: #8b5cf6;" onclick="toggleSection('charts')">
      <div class="section-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
       <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M5 9.2h3V19H5V9.2zM10.6 5h2.8v14h-2.8V5zm5.6 8H19v6h-2.8v-6z"/></svg>
      </div>
      <h2 class="text-xl font-bold text-slate-800">Charts & Analytics</h2>
      <svg class="collapse-icon" width="24" height="24" fill="#64748b" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
     </div>
     
     <div class="section-content" id="chartsContent">
      <!-- Chart Type Selection -->
      <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
       <button class="chart-type-btn active" onclick="changeChartType('bar')" id="chartTypeBar">
        <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M5 9.2h3V19H5V9.2zM10.6 5h2.8v14h-2.8V5zm5.6 8H19v6h-2.8v-6z"/></svg>
        <span>Bar</span>
       </button>
       <button class="chart-type-btn" onclick="changeChartType('pie')" id="chartTypePie">
        <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M11 2v20c-5.07-.5-9-4.79-9-10s3.93-9.5 9-10zm2.03 0v8.99H22c-.47-4.74-4.24-8.52-8.97-8.99zm0 11.01V22c4.74-.47 8.5-4.25 8.97-8.99h-8.97z"/></svg>
        <span>Pie</span>
       </button>
       <button class="chart-type-btn" onclick="changeChartType('doughnut')" id="chartTypeDoughnut">
        <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/></svg>
        <span>Doughnut</span>
       </button>
       <button class="chart-type-btn" onclick="changeChartType('line')" id="chartTypeLine">
        <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>
        <span>Line</span>
       </button>
      </div>
      
      <!-- Charts Grid -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;" class="charts-grid">
       <div class="form-section" style="margin-bottom: 0; padding: 16px;">
        <h3 style="font-weight: 600; color: #334155; margin-bottom: 12px; font-size: 14px;">ðŸ“Š Services Distribution</h3>
        <div class="chart-container">
         <canvas id="servicesChart"></canvas>
        </div>
       </div>
       <div class="form-section" style="margin-bottom: 0; padding: 16px;">
        <h3 style="font-weight: 600; color: #334155; margin-bottom: 12px; font-size: 14px;">ðŸ‘¥ Gender Distribution</h3>
        <div class="chart-container">
         <canvas id="genderChart"></canvas>
        </div>
       </div>
       <div class="form-section" style="margin-bottom: 0; padding: 16px;">
        <h3 style="font-weight: 600; color: #334155; margin-bottom: 12px; font-size: 14px;">ðŸŽ‚ Age Groups</h3>
        <div class="chart-container">
         <canvas id="ageChart"></canvas>
        </div>
       </div>
       <div class="form-section" style="margin-bottom: 0; padding: 16px;">
        <h3 style="font-weight: 600; color: #334155; margin-bottom: 12px; font-size: 14px;">ðŸ’¼ Sectors</h3>
        <div class="chart-container">
         <canvas id="sectorChart"></canvas>
        </div>
       </div>
      </div>
     </div>
    </div>

    <!-- Database Info -->
    <div class="form-section" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-color: #10b981;">
     <div style="display: flex; align-items: center; gap: 12px;">
      <svg width="32" height="32" fill="#10b981" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L18 9l-8 8z"/></svg>
      <div>
       <h3 style="font-weight: 700; color: #065f46; margin-bottom: 4px;">Database Information</h3>
       <p style="font-size: 14px; color: #047857;">Data is saved locally in the <strong>data/</strong> folder as JSON files (registrations.json, checkins.json).</p>
      </div>
     </div>
    </div>
   </div>

   <!-- Toast Container -->
   <div id="toastContainer"></div>
  </div>

  <script>
    // Admin credentials
    const ADMIN_USERNAME = 'admin';
    const ADMIN_PASSWORD = 'Password123!';
    
    // API Base URL
    const API_URL = '';
    
    // Data storage
    let registrationData = [];
    let checkinData = [];
    
    // Load data from server
    async function loadData() {
      try {
        const [regResponse, checkinResponse] = await Promise.all([
          fetch(`${API_URL}/api/registrations`),
          fetch(`${API_URL}/api/checkins`)
        ]);
        registrationData = await regResponse.json();
        checkinData = await checkinResponse.json();
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('Error loading data from server', 'error');
      }
    }
    
    // Pagination state
    let regCurrentPage = 1;
    let regPerPage = 10;
    let regSearchTerm = '';
    let regAgencyFilter = '';
    let regSortBy = 'date_desc';
    
    let checkinCurrentPage = 1;
    let checkinPerPage = 10;
    let checkinSearchTerm = '';
    let checkinServiceFilter = '';
    let checkinSortBy = 'date_desc';
    
    // Show toast notification
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
          ${type === 'success' 
            ? '<path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>'
            : '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>'}
        </svg>
        ${message}
      `;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }
    
    // Get user name by ID
    function getUserName(userId) {
      const user = registrationData.find(r => r.user_id === userId);
      if (user) {
        return [user.first_name, user.middle_initial, user.last_name, user.suffix].filter(Boolean).join(' ');
      }
      return 'Unknown';
    }
    
    // Calculate statistics
    function calculateStatistics() {
      const today = new Date().toDateString();
      
      // Today's check-ins
      const todayCheckins = checkinData.filter(record => {
        const checkinDate = new Date(record.checkin_at).toDateString();
        return checkinDate === today;
      });
      
      const uniqueVisitorsToday = new Set(todayCheckins.map(record => record.user_id));
      
      // Today's service counts
      let todayPrinting = 0, todayPcUse = 0, todayTraining = 0;
      todayCheckins.forEach(record => {
        if (record.services) {
          if (record.services.includes('Printing')) todayPrinting++;
          if (record.services.includes('PC Use')) todayPcUse++;
          if (record.services.includes('Training')) todayTraining++;
        }
      });
      
      // All time service counts
      let allPrinting = 0, allPcUse = 0, allTraining = 0;
      checkinData.forEach(record => {
        if (record.services) {
          if (record.services.includes('Printing')) allPrinting++;
          if (record.services.includes('PC Use')) allPcUse++;
          if (record.services.includes('Training')) allTraining++;
        }
      });
      
      // Gender distribution
      const genderCounts = { Male: 0, Female: 0, 'Prefer not to say': 0 };
      registrationData.forEach(r => {
        if (r.gender && genderCounts.hasOwnProperty(r.gender)) {
          genderCounts[r.gender]++;
        }
      });
      
      // Age group distribution
      const ageCounts = { 'Under 18': 0, '18-24': 0, '25-34': 0, '35-44': 0, '45+': 0 };
      registrationData.forEach(r => {
        if (r.age_group && ageCounts.hasOwnProperty(r.age_group)) {
          ageCounts[r.age_group]++;
        }
      });
      
      // Sector distribution
      const sectorCounts = {};
      registrationData.forEach(r => {
        if (r.sector) {
          sectorCounts[r.sector] = (sectorCounts[r.sector] || 0) + 1;
        }
      });
      
      return {
        // Today stats
        todayVisitors: uniqueVisitorsToday.size,
        todayCheckins: todayCheckins.length,
        todayPrinting,
        todayPcUse,
        todayTraining,
        // All time stats
        allRegistrations: registrationData.length,
        allCheckins: checkinData.length,
        allPrinting,
        allPcUse,
        allTraining,
        // Distributions
        genderCounts,
        ageCounts,
        sectorCounts,
        serviceCounts: { Printing: allPrinting, 'PC Use': allPcUse, Training: allTraining }
      };
    }
    
    // Chart instances
    let servicesChart, genderChart, ageChart, sectorChart;
    let currentChartType = 'bar';
    
    // Chart colors
    const chartColors = {
      primary: ['#0ea5e9', '#06b6d4', '#14b8a6', '#10b981', '#22c55e'],
      services: ['#f59e0b', '#8b5cf6', '#ec4899'],
      gender: ['#3b82f6', '#ec4899', '#94a3b8'],
      age: ['#06b6d4', '#0ea5e9', '#3b82f6', '#8b5cf6', '#a855f7'],
      sector: ['#f59e0b', '#10b981', '#3b82f6', '#ec4899', '#8b5cf6']
    };
    
    // Switch stats period
    // Stats filter state
    let currentStatsPeriod = 'today';
    let currentStatsFilter = 'all';
    let currentStatsSort = 'newest';
    
    // Toggle section collapse
    function toggleSection(sectionName) {
      const contentMap = {
        'stats': 'statsContent',
        'charts': 'chartsContent',
        'reg': 'regContent',
        'checkin': 'checkinContent'
      };
      const headerMap = {
        'stats': 'statsSection',
        'charts': 'chartsSection',
        'reg': 'regSection',
        'checkin': 'checkinSection'
      };
      
      const content = document.getElementById(contentMap[sectionName]);
      const section = document.getElementById(headerMap[sectionName]);
      const header = section.querySelector('.section-header');
      
      content.classList.toggle('collapsed');
      header.classList.toggle('collapsed');
    }
    
    // Switch stats period
    function switchStatsPeriod(period) {
      currentStatsPeriod = period;
      document.getElementById('tabToday').classList.toggle('active', period === 'today');
      document.getElementById('tabAll').classList.toggle('active', period === 'all');
      
      // Clear date/time inputs when switching to preset periods
      if (period === 'today' || period === 'all') {
        document.getElementById('statsDateFrom').value = '';
        document.getElementById('statsTimeFrom').value = '';
        document.getElementById('statsDateTo').value = '';
        document.getElementById('statsTimeTo').value = '';
      }
      
      updateFilteredStats();
    }
    
    // Set stats filter
    function setStatsFilter(filter) {
      currentStatsFilter = filter;
      
      // Update button states
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).classList.add('active');
      
      // Show/hide stat cards based on filter
      const cards = {
        'all': ['cardRegistrations', 'cardCheckins', 'cardPrinting', 'cardPcuse', 'cardTraining'],
        'registrations': ['cardRegistrations'],
        'checkins': ['cardCheckins'],
        'printing': ['cardPrinting'],
        'pcuse': ['cardPcuse'],
        'training': ['cardTraining']
      };
      
      const allCards = ['cardRegistrations', 'cardCheckins', 'cardPrinting', 'cardPcuse', 'cardTraining'];
      allCards.forEach(cardId => {
        const card = document.getElementById(cardId);
        if (card) {
          card.style.display = cards[filter].includes(cardId) ? 'block' : 'none';
        }
      });
      
      // Adjust grid columns based on visible cards
      const grid = document.getElementById('statsCardsGrid');
      const visibleCount = cards[filter].length;
      grid.style.gridTemplateColumns = `repeat(${Math.min(visibleCount, 5)}, 1fr)`;
      
      updateFilteredStats();
    }
    
    // Set stats sort
    function setStatsSort(sort) {
      currentStatsSort = sort;
      updateFilteredStats();
    }
    
    // Set stats sort from select dropdown
    function setStatsSortFromSelect(sort) {
      currentStatsSort = sort;
      updateFilteredStats();
    }
    
    // Reset stats filters
    function resetStatsFilters() {
      currentStatsPeriod = 'today';
      currentStatsFilter = 'all';
      currentStatsSort = 'newest';
      
      document.getElementById('statsDateFrom').value = '';
      document.getElementById('statsTimeFrom').value = '';
      document.getElementById('statsDateTo').value = '';
      document.getElementById('statsTimeTo').value = '';
      document.getElementById('statsSortSelect').value = 'newest';
      
      document.querySelectorAll('.stats-tab').forEach(btn => btn.classList.remove('active'));
      document.getElementById('tabToday').classList.add('active');
      
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('filterAll').classList.add('active');
      
      // Show all cards
      const allCards = ['cardRegistrations', 'cardCheckins', 'cardPrinting', 'cardPcuse', 'cardTraining'];
      allCards.forEach(cardId => {
        const card = document.getElementById(cardId);
        if (card) card.style.display = 'block';
      });
      
      document.getElementById('statsCardsGrid').style.gridTemplateColumns = 'repeat(5, 1fr)';
      
      updateFilteredStats();
    }
    
    // Update filtered statistics
    function updateFilteredStats() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      let dateFrom = null;
      let dateTo = null;
      let dateRangeText = '';
      
      // Check if custom date/time is selected
      const fromDateInput = document.getElementById('statsDateFrom').value;
      const fromTimeInput = document.getElementById('statsTimeFrom').value;
      const toDateInput = document.getElementById('statsDateTo').value;
      const toTimeInput = document.getElementById('statsTimeTo').value;
      
      const hasCustomRange = fromDateInput || toDateInput;
      
      if (hasCustomRange) {
        currentStatsPeriod = 'custom';
        document.querySelectorAll('.stats-tab').forEach(btn => btn.classList.remove('active'));
        
        if (fromDateInput) {
          dateFrom = new Date(fromDateInput);
          if (fromTimeInput) {
            const [hours, minutes] = fromTimeInput.split(':');
            dateFrom.setHours(parseInt(hours), parseInt(minutes), 0, 0);
          } else {
            dateFrom.setHours(0, 0, 0, 0);
          }
        }
        
        if (toDateInput) {
          dateTo = new Date(toDateInput);
          if (toTimeInput) {
            const [hours, minutes] = toTimeInput.split(':');
            dateTo.setHours(parseInt(hours), parseInt(minutes), 59, 999);
          } else {
            dateTo.setHours(23, 59, 59, 999);
          }
        }
        
        // Build date range text
        const formatDateTime = (date, hasTime) => {
          const dateStr = date.toLocaleDateString();
          if (hasTime) {
            return dateStr + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          }
          return dateStr;
        };
        
        if (dateFrom && dateTo) {
          dateRangeText = formatDateTime(dateFrom, fromTimeInput) + ' - ' + formatDateTime(dateTo, toTimeInput);
        } else if (dateFrom) {
          dateRangeText = 'From ' + formatDateTime(dateFrom, fromTimeInput);
        } else if (dateTo) {
          dateRangeText = 'Until ' + formatDateTime(dateTo, toTimeInput);
        }
      } else if (currentStatsPeriod === 'today') {
        dateFrom = today;
        dateTo = new Date(today.getTime() + 24 * 60 * 60 * 1000);
        dateRangeText = 'Today (' + today.toLocaleDateString() + ')';
      } else {
        dateRangeText = 'All Time';
      }
      
      // Filter registrations
      let filteredRegs = registrationData.filter(r => {
        if (!dateFrom && !dateTo) return true;
        const regDate = new Date(r.registered_at);
        if (dateFrom && regDate < dateFrom) return false;
        if (dateTo && regDate > dateTo) return false;
        return true;
      });
      
      // Filter check-ins
      let filteredCheckins = checkinData.filter(c => {
        if (!dateFrom && !dateTo) return true;
        const checkinDate = new Date(c.checkin_at);
        if (dateFrom && checkinDate < dateFrom) return false;
        if (dateTo && checkinDate > dateTo) return false;
        return true;
      });
      
      // Count services
      let printingCount = 0, pcUseCount = 0, trainingCount = 0;
      filteredCheckins.forEach(c => {
        if (c.services) {
          if (c.services.includes('Printing')) printingCount++;
          if (c.services.includes('PC Use')) pcUseCount++;
          if (c.services.includes('Training')) trainingCount++;
        }
      });
      
      // Create stats array for sorting
      let statsArray = [
        { name: 'registrations', value: filteredRegs.length, element: 'filteredRegistrations' },
        { name: 'checkins', value: filteredCheckins.length, element: 'filteredCheckins' },
        { name: 'printing', value: printingCount, element: 'filteredPrinting' },
        { name: 'pcuse', value: pcUseCount, element: 'filteredPcUse' },
        { name: 'training', value: trainingCount, element: 'filteredTraining' }
      ];
      
      // Apply sorting
      if (currentStatsSort === 'highest') {
        statsArray.sort((a, b) => b.value - a.value);
      } else if (currentStatsSort === 'lowest') {
        statsArray.sort((a, b) => a.value - b.value);
      }
      
      // Update values
      statsArray.forEach(stat => {
        const el = document.getElementById(stat.element);
        if (el) el.textContent = stat.value;
      });
      
      // Update date range display
      document.getElementById('statsDateRangeText').textContent = dateRangeText;
    }
    
    // Add event listeners for date/time inputs
    document.addEventListener('DOMContentLoaded', function() {
      const dateFrom = document.getElementById('statsDateFrom');
      const timeFrom = document.getElementById('statsTimeFrom');
      const dateTo = document.getElementById('statsDateTo');
      const timeTo = document.getElementById('statsTimeTo');
      
      // Set max date to today (prevent future dates)
      const today = new Date().toISOString().split('T')[0];
      if (dateFrom) dateFrom.setAttribute('max', today);
      if (dateTo) dateTo.setAttribute('max', today);
      
      // Add change listeners
      const updateOnChange = () => updateFilteredStats();
      
      if (dateFrom) dateFrom.addEventListener('change', updateOnChange);
      if (timeFrom) timeFrom.addEventListener('change', updateOnChange);
      if (dateTo) dateTo.addEventListener('change', updateOnChange);
      if (timeTo) timeTo.addEventListener('change', updateOnChange);
    });
    
    // Change chart type
    function changeChartType(type) {
      currentChartType = type;
      
      // Update button states
      document.querySelectorAll('.chart-type-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('chartType' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');
      
      // Recreate charts
      updateCharts();
    }
    
    // Create/update charts
    function updateCharts() {
      const stats = calculateStatistics();
      
      // Destroy existing charts
      if (servicesChart) servicesChart.destroy();
      if (genderChart) genderChart.destroy();
      if (ageChart) ageChart.destroy();
      if (sectorChart) sectorChart.destroy();
      
      const chartType = currentChartType === 'line' ? 'line' : currentChartType;
      
      // Services Chart
      servicesChart = new Chart(document.getElementById('servicesChart'), {
        type: chartType,
        data: {
          labels: ['Printing', 'PC Use', 'Training'],
          datasets: [{
            label: 'Services',
            data: [stats.serviceCounts.Printing, stats.serviceCounts['PC Use'], stats.serviceCounts.Training],
            backgroundColor: chartColors.services,
            borderColor: chartColors.services,
            borderWidth: chartType === 'line' ? 2 : 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: chartType !== 'bar' && chartType !== 'line' } }
        }
      });
      
      // Gender Chart
      genderChart = new Chart(document.getElementById('genderChart'), {
        type: chartType,
        data: {
          labels: Object.keys(stats.genderCounts),
          datasets: [{
            label: 'Gender',
            data: Object.values(stats.genderCounts),
            backgroundColor: chartColors.gender,
            borderColor: chartColors.gender,
            borderWidth: chartType === 'line' ? 2 : 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: chartType !== 'bar' && chartType !== 'line' } }
        }
      });
      
      // Age Chart
      ageChart = new Chart(document.getElementById('ageChart'), {
        type: chartType,
        data: {
          labels: Object.keys(stats.ageCounts),
          datasets: [{
            label: 'Age Groups',
            data: Object.values(stats.ageCounts),
            backgroundColor: chartColors.age,
            borderColor: chartColors.age,
            borderWidth: chartType === 'line' ? 2 : 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: chartType !== 'bar' && chartType !== 'line' } }
        }
      });
      
      // Sector Chart
      const sectorLabels = Object.keys(stats.sectorCounts);
      const sectorData = Object.values(stats.sectorCounts);
      sectorChart = new Chart(document.getElementById('sectorChart'), {
        type: chartType,
        data: {
          labels: sectorLabels.length > 0 ? sectorLabels : ['No data'],
          datasets: [{
            label: 'Sectors',
            data: sectorData.length > 0 ? sectorData : [0],
            backgroundColor: chartColors.sector.slice(0, sectorLabels.length || 1),
            borderColor: chartColors.sector.slice(0, sectorLabels.length || 1),
            borderWidth: chartType === 'line' ? 2 : 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: chartType !== 'bar' && chartType !== 'line' } }
        }
      });
    }
    
    // Filter and sort registrations
    function filterAndSortRegistrations() {
      let filtered = [...registrationData];
      
      if (regSearchTerm) {
        const term = regSearchTerm.toLowerCase();
        filtered = filtered.filter(record => {
          const fullName = [record.first_name, record.middle_initial, record.last_name, record.suffix]
            .filter(Boolean).join(' ').toLowerCase();
          return fullName.includes(term) || 
                 (record.email || '').toLowerCase().includes(term) ||
                 (record.user_id || '').toLowerCase().includes(term);
        });
      }
      
      if (regAgencyFilter) {
        filtered = filtered.filter(record => record.agency === regAgencyFilter);
      }
      
      filtered.sort((a, b) => {
        switch(regSortBy) {
          case 'date_desc': return new Date(b.registered_at) - new Date(a.registered_at);
          case 'date_asc': return new Date(a.registered_at) - new Date(b.registered_at);
          case 'name_asc':
            const nameA = [a.first_name, a.last_name].join(' ').toLowerCase();
            const nameB = [b.first_name, b.last_name].join(' ').toLowerCase();
            return nameA.localeCompare(nameB);
          case 'name_desc':
            const nameA2 = [a.first_name, a.last_name].join(' ').toLowerCase();
            const nameB2 = [b.first_name, b.last_name].join(' ').toLowerCase();
            return nameB2.localeCompare(nameA2);
          default: return 0;
        }
      });
      
      return filtered;
    }
    
    // Filter and sort check-ins
    function filterAndSortCheckins() {
      let filtered = [...checkinData];
      
      if (checkinSearchTerm) {
        const term = checkinSearchTerm.toLowerCase();
        filtered = filtered.filter(record => {
          return (record.user_id || '').toLowerCase().includes(term) ||
                 (record.services || '').toLowerCase().includes(term);
        });
      }
      
      if (checkinServiceFilter) {
        filtered = filtered.filter(record => 
          (record.services || '').includes(checkinServiceFilter)
        );
      }
      
      filtered.sort((a, b) => {
        switch(checkinSortBy) {
          case 'date_desc': return new Date(b.checkin_at) - new Date(a.checkin_at);
          case 'date_asc': return new Date(a.checkin_at) - new Date(b.checkin_at);
          case 'id_asc': return (a.user_id || '').localeCompare(b.user_id || '');
          case 'id_desc': return (b.user_id || '').localeCompare(a.user_id || '');
          default: return 0;
        }
      });
      
      return filtered;
    }
    
    // Render pagination
    function renderPagination(containerId, currentPage, totalPages, onPageChange) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      
      const prevBtn = document.createElement('button');
      prevBtn.className = 'pagination-btn';
      prevBtn.textContent = 'â† Prev';
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => onPageChange(currentPage - 1);
      container.appendChild(prevBtn);
      
      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, startPage + 4);
      if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);
      
      if (startPage > 1) {
        const firstBtn = document.createElement('button');
        firstBtn.className = 'pagination-btn';
        firstBtn.textContent = '1';
        firstBtn.onclick = () => onPageChange(1);
        container.appendChild(firstBtn);
        if (startPage > 2) {
          const dots = document.createElement('span');
          dots.textContent = '...';
          dots.style.padding = '8px';
          dots.style.color = '#64748b';
          container.appendChild(dots);
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = 'pagination-btn' + (i === currentPage ? ' active' : '');
        pageBtn.textContent = i;
        pageBtn.onclick = () => onPageChange(i);
        container.appendChild(pageBtn);
      }
      
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const dots = document.createElement('span');
          dots.textContent = '...';
          dots.style.padding = '8px';
          dots.style.color = '#64748b';
          container.appendChild(dots);
        }
        const lastBtn = document.createElement('button');
        lastBtn.className = 'pagination-btn';
        lastBtn.textContent = totalPages;
        lastBtn.onclick = () => onPageChange(totalPages);
        container.appendChild(lastBtn);
      }
      
      const nextBtn = document.createElement('button');
      nextBtn.className = 'pagination-btn';
      nextBtn.textContent = 'Next â†’';
      nextBtn.disabled = currentPage === totalPages || totalPages === 0;
      nextBtn.onclick = () => onPageChange(currentPage + 1);
      container.appendChild(nextBtn);
    }
    
    // Update agency filter
    function updateAgencyFilter() {
      const agencyFilter = document.getElementById('regAgencyFilter');
      const agencies = [...new Set(registrationData.map(r => r.agency).filter(Boolean))].sort();
      const currentValue = agencyFilter.value;
      agencyFilter.innerHTML = '<option value="">All Agencies</option>';
      agencies.forEach(agency => {
        const option = document.createElement('option');
        option.value = agency;
        option.textContent = agency;
        agencyFilter.appendChild(option);
      });
      agencyFilter.value = currentValue;
    }
    
    // Update dashboard
    async function updateDashboard() {
      // Reload data from server
      await loadData();
      
      // Update filtered statistics
      updateFilteredStats();
      
      // Update charts
      updateCharts();
      
      updateAgencyFilter();
      
      // Update registration table
      const filteredRegs = filterAndSortRegistrations();
      const regTableBody = document.getElementById('registrationTableBody');
      
      if (filteredRegs.length === 0) {
        regTableBody.innerHTML = '<tr><td colspan="7" style="padding: 40px; text-align: center; color: #94a3b8;">No registrations found</td></tr>';
        document.getElementById('regShowingStart').textContent = '0';
        document.getElementById('regShowingEnd').textContent = '0';
        document.getElementById('regShowingTotal').textContent = '0';
        renderPagination('regPaginationButtons', 1, 0, () => {});
      } else {
        const totalPages = Math.ceil(filteredRegs.length / regPerPage);
        const startIdx = (regCurrentPage - 1) * regPerPage;
        const endIdx = Math.min(startIdx + regPerPage, filteredRegs.length);
        const pageData = filteredRegs.slice(startIdx, endIdx);
        
        regTableBody.innerHTML = pageData.map((record) => {
          const date = new Date(record.registered_at);
          const formattedDate = date.toLocaleDateString('en-US', { 
            month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
          });
          const fullName = [record.first_name, record.middle_initial, record.last_name, record.suffix]
            .filter(Boolean).join(' ');
          return `
            <tr style="border-bottom: 1px solid #e2e8f0;">
              <td style="padding: 12px; border: 1px solid #e2e8f0; font-weight: 600; color: #64748b;">${record.registration_number || '-'}</td>
              <td style="padding: 12px; border: 1px solid #e2e8f0; font-family: monospace; font-weight: 600; color: #0ea5e9;">${record.user_id || ''}</td>
              <td style="padding: 12px; border: 1px solid #e2e8f0;">${fullName}</td>
              <td style="padding: 12px; border: 1px solid #e2e8f0;">${record.email || ''}</td>
              <td style="padding: 12px; border: 1px solid #e2e8f0;">${record.agency || ''}</td>
              <td style="padding: 12px; border: 1px solid #e2e8f0;">${record.region || ''}</td>
              <td style="padding: 12px; border: 1px solid #e2e8f0;">${formattedDate}</td>
            </tr>
          `;
        }).join('');
        
        document.getElementById('regShowingStart').textContent = startIdx + 1;
        document.getElementById('regShowingEnd').textContent = endIdx;
        document.getElementById('regShowingTotal').textContent = filteredRegs.length;
        
        renderPagination('regPaginationButtons', regCurrentPage, totalPages, (page) => {
          regCurrentPage = page;
          updateDashboard();
        });
      }
      
      // Update check-in table
      const filteredCheckins = filterAndSortCheckins();
      const checkinTableBody = document.getElementById('checkinTableBody');
      
      if (filteredCheckins.length === 0) {
        checkinTableBody.innerHTML = '<tr><td colspan="4" style="padding: 40px; text-align: center; color: #94a3b8;">No check-ins found</td></tr>';
        document.getElementById('checkinShowingStart').textContent = '0';
        document.getElementById('checkinShowingEnd').textContent = '0';
        document.getElementById('checkinShowingTotal').textContent = '0';
        renderPagination('checkinPaginationButtons', 1, 0, () => {});
      } else {
        const totalPages = Math.ceil(filteredCheckins.length / checkinPerPage);
        const startIdx = (checkinCurrentPage - 1) * checkinPerPage;
        const endIdx = Math.min(startIdx + checkinPerPage, filteredCheckins.length);
        const pageData = filteredCheckins.slice(startIdx, endIdx);
        
        checkinTableBody.innerHTML = pageData.map(record => {
          const date = new Date(record.checkin_at);
          const formattedDate = date.toLocaleDateString('en-US', { 
            month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
          });
          const userName = getUserName(record.user_id);
          return `
            <tr style="border-bottom: 1px solid #e2e8f0;">
              <td style="padding: 12px; border: 1px solid #e2e8f0; font-family: monospace; font-weight: 600; color: #10b981;">${record.user_id || ''}</td>
              <td style="padding: 12px; border: 1px solid #e2e8f0;">${userName}</td>
              <td style="padding: 12px; border: 1px solid #e2e8f0;">${record.services || ''}</td>
              <td style="padding: 12px; border: 1px solid #e2e8f0;">${formattedDate}</td>
            </tr>
          `;
        }).join('');
        
        document.getElementById('checkinShowingStart').textContent = startIdx + 1;
        document.getElementById('checkinShowingEnd').textContent = endIdx;
        document.getElementById('checkinShowingTotal').textContent = filteredCheckins.length;
        
        renderPagination('checkinPaginationButtons', checkinCurrentPage, totalPages, (page) => {
          checkinCurrentPage = page;
          updateDashboard();
        });
      }
    }
    
    // Export to CSV
    function exportToCSV(data, filename) {
      if (data.length === 0) {
        showToast('No data to export', 'error');
        return;
      }
      
      const headers = Object.keys(data[0]);
      const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(h => {
          let val = row[h] || '';
          if (typeof val === 'string' && (val.includes(',') || val.includes('"') || val.includes('\n'))) {
            val = '"' + val.replace(/"/g, '""') + '"';
          }
          return val;
        }).join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      
      showToast(`${filename} exported successfully!`);
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Admin form submission
      document.getElementById('adminForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('adminUsername').value;
        const password = document.getElementById('adminPassword').value;
        
        if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
          showToast('Login successful!');
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('adminDashboard').style.display = 'block';
          await updateDashboard();
          this.reset();
        } else {
          showToast('Invalid username or password', 'error');
          document.getElementById('adminPassword').value = '';
        }
      });
      
      // Logout
      document.getElementById('logoutBtn').addEventListener('click', function() {
        document.getElementById('adminDashboard').style.display = 'none';
        document.getElementById('loginSection').style.display = 'block';
        showToast('Logged out successfully');
      });
      
      // Export buttons
      document.getElementById('exportRegBtn').addEventListener('click', function() {
        const date = new Date().toISOString().split('T')[0];
        exportToCSV(registrationData, `registrations_${date}.csv`);
      });
      
      document.getElementById('exportCheckinBtn').addEventListener('click', function() {
        const date = new Date().toISOString().split('T')[0];
        exportToCSV(checkinData, `checkins_${date}.csv`);
      });
      
      // Filter event listeners
      document.getElementById('regSearchInput').addEventListener('input', (e) => {
        regSearchTerm = e.target.value;
        regCurrentPage = 1;
        updateDashboard();
      });
      
      document.getElementById('regAgencyFilter').addEventListener('change', (e) => {
        regAgencyFilter = e.target.value;
        regCurrentPage = 1;
        updateDashboard();
      });
      
      document.getElementById('regSortSelect').addEventListener('change', (e) => {
        regSortBy = e.target.value;
        regCurrentPage = 1;
        updateDashboard();
      });
      
      document.getElementById('regPerPageSelect').addEventListener('change', (e) => {
        regPerPage = parseInt(e.target.value);
        regCurrentPage = 1;
        updateDashboard();
      });
      
      document.getElementById('checkinSearchInput').addEventListener('input', (e) => {
        checkinSearchTerm = e.target.value;
        checkinCurrentPage = 1;
        updateDashboard();
      });
      
      document.getElementById('checkinServiceFilter').addEventListener('change', (e) => {
        checkinServiceFilter = e.target.value;
        checkinCurrentPage = 1;
        updateDashboard();
      });
      
      document.getElementById('checkinSortSelect').addEventListener('change', (e) => {
        checkinSortBy = e.target.value;
        checkinCurrentPage = 1;
        updateDashboard();
      });
      
      document.getElementById('checkinPerPageSelect').addEventListener('change', (e) => {
        checkinPerPage = parseInt(e.target.value);
        checkinCurrentPage = 1;
        updateDashboard();
      });
      
      // Auto-refresh data every 30 seconds when dashboard is visible
      setInterval(() => {
        if (document.getElementById('adminDashboard').style.display !== 'none') {
          updateDashboard();
        }
      }, 30000);
    });
  </script>
 </body>
</html>
